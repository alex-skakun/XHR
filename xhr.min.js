(function t(){"use strict";!function(t,EventCollection,EventCollectionItem){function e(t){var e=r.findForTarget(t);return e||(e=new EventCollectionItem(t),r.add(e)),e}function EventTargetExtendable(t){if(Array.isArray(t)){var e={};t.forEach(function(t){var r=t.trim().toLowerCase(),n="on"+r;Object.defineProperty(this,n,{enumerable:!0,configurable:!1,get:function(){return e[r]||null},set:function(t){var n=e[r];n&&this.removeEventListener(r,n),"function"==typeof t&&(e[r]=t,this.addEventListener(r,t))}})},this)}}var r=new EventCollection;EventTargetExtendable.prototype.addEventListener=function(t,r){if("function"==typeof r){var n=e(this);return n.addListener(t,r)}return!1},EventTargetExtendable.prototype.removeEventListener=function(t,r){var n=e(this);return n.removeListener(t,r)},EventTargetExtendable.prototype.dispatchEvent=function(t){var r=e(this),n=r.getListenersByType(t),o=Array.prototype.slice.call(arguments,1),s=this;if(n){var i=[];n.forEach(function(t){"function"==typeof t&&i.push(t)}),i.forEach(function(t){t.apply(s,o)})}},EventTargetExtendable.prototype.removeAllListeners=function(t){var n=e(this);return t?n.removeListeners(t):r.remove(n)};for(var n=EventTargetExtendable.prototype,o=Object.keys(EventTargetExtendable.prototype),s=0,i=o.length;i>s;s++)Object.defineProperty(n,o[s],{enumerable:!1,configurable:!1,writable:!1});t.EventTargetExtendable=EventTargetExtendable}(this,function(){function EventCollection(){var t;try{t=Map}catch(e){t=Array}this.collection=new t}return EventCollection.prototype.findForTarget=function(t){if(!Array.isArray(this.collection))return this.collection.get(t);for(var e=this.collection,r=0,n=e.length;n>r;r++){var o=e[r];if(o.target===t)return o}return null},EventCollection.prototype.add=function(t){Array.isArray(this.collection)?this.collection.push(t):this.collection.set(t.target,t)},EventCollection.prototype.remove=function(t){if(Array.isArray(this.collection)){var e=this.collection.indexOf(t);if(e>-1){var r=this.collection.splice(e,1);return 1===r.length}return!1}return this.collection["delete"](t.target)},EventCollection}(),function(){function EventCollectionItem(t){this.target=t,this.listeners={}}return EventCollectionItem.createListenersCollection=function(){var t;try{t=Set}catch(e){t=Array}return new t},EventCollectionItem.prototype.getListenersByType=function(t){var e=this.listeners[t];return e||(e=EventCollectionItem.createListenersCollection(),this.listeners[t]=e),e},EventCollectionItem.prototype.addListener=function(t,e){var r=this.getListenersByType(t);return Array.isArray(r)?~r.indexOf(e)?!1:(r.push(e),!0):r.has(e)?!1:(r.add(e),!0)},EventCollectionItem.prototype.removeListener=function(t,e){var r=this.getListenersByType(t);if(Array.isArray(r)){var n=r.indexOf(e);if(n>-1){var o=r.splice(n,1);return 1===o.length}return!1}return r["delete"](e)},EventCollectionItem.prototype.removeListeners=function(t){var e=this.getListenersByType(t);return Array.isArray(e)?e.splice(0,e.length):e.clear(),!0},EventCollectionItem}());var XHRActions=function(){function XHRActions(t){this._promise=t}return XHRActions.prototype.isInProgress=function(){return this._promise.inProgress},XHRActions.prototype.interceptors=function(t){return this._promise.interceptors=t,this},XHRActions.prototype.silent=function(){return this._promise.silent=!0,this},XHRActions.prototype.error=function(t){return this._promise.addEventListener("error",t),this},XHRActions.prototype.loadStart=function(t){return this._promise.addEventListener("loadstart",t),this},XHRActions.prototype.progress=function(t){return this._promise.addEventListener("progress",t),this},XHRActions.prototype.loadEnd=function(t){return this._promise.addEventListener("loadend",t),this},XHRActions.prototype.abort=function(t){return this._promise.addEventListener("abort",t),this},XHRActions.prototype.load=function(t){return this._promise.addEventListener("load",t),this},XHRActions.prototype.success=function(t){return this._promise.addEventListener("success",t),this},XHRActions.prototype.timeout=function(t){return this._promise.addEventListener("timeout",t),this},XHRActions.prototype.readyStateChange=function(t){return this._promise.addEventListener("readystatechange",t),this},XHRActions.prototype.then=function(t){return this._promise.queue.push(t),this},XHRActions.prototype.getXHR=function(){return this._promise.xhrCollection},XHRActions}(),XHRPromise=function(t){function e(t){var e=t.responseType;return{readyState:t.readyState,response:t.response,responseText:""===e||"text"===e?t.responseText:null,status:t.status,statusText:t.statusText}}function XHRPromise(t){this.inProgress=!0,this.xhrCollection=new XHRCollection(this),void 0!==t&&this.xhrCollection.push(t),this.silent=!1,this.interceptors={},this.queue=[],this.actions=new XHRActions(this)}function n(t){for(var e=[],r=Object.getPrototypeOf(t);r;)e.push(r),r=Object.getPrototypeOf(r.constructor.prototype);return e}function o(t){var e={},r=n(t).reverse().map(function(t){return Object.getOwnPropertyNames(t).map(function(e){return{property:e,proto:t}})}).reduce(function(t,e){return t.concat(e)},[]);return Array.isArray(r)&&r.forEach(function(r){var n=Object.getOwnPropertyDescriptor(r.proto,r.property),o=t[r.property];"function"!=typeof n.get||o instanceof Object||(e[r.property]=o)}),e}var s=t.Promise,i={request:"request",success:"response",error:"responseError",abort:"abort"};return XHRPromise.prototype=Object.create(EventTargetExtendable.prototype,{constructor:{value:XHRPromise}}),XHRPromise.prototype.destroy=function(){this.dispatchEvent("destroy"),r.workerMode&&this.sendMessageToMainThread("destroy"),this.inProgress=!1,this.removeAllListeners()},XHRPromise.prototype.sendMessageToMainThread=function(r,n,s){var i={guid:this.guid,eventName:r,data:n,xhrOptions:s?e(s):null};try{t.postMessage(i)}catch(a){i.data=o(n),t.postMessage(i)}},XHRPromise.prototype.applyCallback=function(t,e,n){var o=this,a=this.checkInterceptor(i[t],n),u=function(){var a=o.applyOwnInterceptor(i[t],e),u=function(e){r.workerMode?o.sendMessageToMainThread(t,e,n):o.dispatchEvent(t,e,n),"success"!==t&&"error"!==t&&"abort"!==t&&"timeout"!==t||o.destroy()};s&&a instanceof s?a.then(u,c):u(a)},c=function(){o.destroy()};s&&a instanceof s?a.then(u,c):a?u():o.destroy()},XHRPromise.prototype.checkInterceptor=function(t,e){return t&&"function"==typeof r.interceptors[t]?this.silent||r.interceptors[t](e):!0},XHRPromise.prototype.applyOwnInterceptor=function(t,e){var r=this.interceptors[t];return"function"==typeof r?r(e):e},XHRPromise.prototype.getNext=function(){return this.queue.shift()},XHRPromise.prototype.addToQueue=function(t){if(t instanceof XHRCollection){var e=this.xhrCollection,r=e.length,n=t.slice();n.unshift(0),n.unshift(r),e.splice.apply(e,n)}else this.xhrCollection.push(t);return this},XHRPromise}(this),XHRCollection=function(){function XHRCollection(t){Array.call(this),this.promise=t,this.aborted=!1}return XHRCollection.prototype=Object.create(Array.prototype,{constructor:{value:XHRCollection},abort:{value:function(){this.forEach(function(t){t instanceof XMLHttpRequest||t instanceof e?t.abort():(clearTimeout(t),this.promise.applyCallback("abort"))},this),this.aborted=!0}}}),XHRCollection}(),e=function(){function t(t,e){var n=this;this.guid=t,this.config=e,this.config.attributes=this.config.attributes||{},this.config.headers=this.config.headers||{},this.xhrOptions={readyState:XMLHttpRequest.UNSENT,response:null,responseText:null,status:0,statusText:null},r._worker.addEventListener("message",function o(t){if(t.data.guid===n.guid){var e=t.data,s=e.eventName,i=e.data;"destroy"===s?(r._worker.removeEventListener("message",o),n.removeAllListeners()):(n.applyXHROptions(e.xhrOptions),n.dispatchEvent("event",s,i,n))}})}return t.prototype=Object.create(EventTargetExtendable.prototype,{constructor:{value:t},responseType:{get:function(){return this.config.attributes.responseType||""},set:function(t){this.config.attributes.responseType=t}},timeout:{get:function(){return this.config.attributes.timeout||0},set:function(t){this.config.attributes.timeout=t}},readyState:{get:function(){return this.xhrOptions.readyState}},response:{get:function(){return this.xhrOptions.response}},responseText:{get:function(){return this.xhrOptions.responseText}},status:{get:function(){return this.xhrOptions.status}},statusText:{get:function(){return this.xhrOptions.statusText}}}),t.prototype.applyXHROptions=function(t){var e=this.responseType;this.xhrOptions.readyState=t.readyState,this.xhrOptions.response=t.response,this.xhrOptions.responseText=""===e||"text"===e?t.responseText:null,this.xhrOptions.status=t.status,this.xhrOptions.statusText=t.statusText},t.prototype.open=function(t,e,r){this.config.method=t,this.config.async=r,this.xhrOptions.readyState=XMLHttpRequest.OPENED,this.dispatchEvent("readystatechange")},t.prototype.send=function(t){this.config.data=t,r._worker.postMessage({guid:this.guid,type:"request",options:this.config})},t.prototype.setRequestHeader=function(t,e){this.config.headers[t]=e},t.prototype.abort=function(){r._worker.postMessage({guid:this.guid,type:"abort"})},t}(),r=function(r){function n(t,e){var r,n,o,s,i={},a=Object.keys(f.defaults.attributes);for(o=0,s=a.length;s>o;o++)r=a[o],i[r]=f.defaults.attributes[r];if(t&&"object"==typeof t){var u=Object.keys(t);for(o=0,s=u.length;s>o;o++)r=u[o],i[r]=t[r],e[r]=t[r]}for(n=Object.keys(i),o=0,s=n.length;s>o;o++)r=n[o],e[r]=i[r]}function o(t){var e="";if(t&&"object"==typeof t){var r=[],n=Object.keys(t);n.forEach(function(e){var n=t[e];Array.isArray(n)?n.forEach(function(t){r.push(e+"="+t)}):"object"==typeof n&&n?r.push(e+"="+JSON.stringify(n)):"undefined"!=typeof n&&r.push(e+"="+n)}),r.length&&(e="?"+r.join("&"))}return e}function s(t){var e=null;if(void 0!==t&&null!==t){var n=t;e=n instanceof(r.ArrayBufferView||r.ArrayBuffer)||n instanceof r.Blob||(f.workerMode?!1:n instanceof r.Document)||n instanceof r.FormData?n:"object"==typeof n&&n?JSON.stringify(n):String(n)}return e}function i(t,e){var r,n,o,s,i,a,u={},c=Object.keys(f.defaults.headers);for(i=0,a=c.length;a>i;i++)o=c[i],u[o.toLowerCase()]=f.defaults.headers[o];if(e&&"object"==typeof e)for(r=Object.keys(e),i=0,a=r.length;a>i;i++)o=r[i],u[o.toLowerCase()]=e[o];for(n=Object.keys(u),i=0,a=n.length;a>i;i++)o=n[i],s=u[o],"undefined"!=typeof s&&null!==s&&t.setRequestHeader(o,String(s))}function a(t,e,r){return function(n){return"string"==typeof t?e.applyCallback(t,n,r):"function"==typeof t?t.call(this,n,e,r):void 0}}function u(t){var e;try{e=JSON.parse(t.responseText)}catch(r){e=t.responseText}return e}function c(t,e,r){try{f(t,e)}catch(n){e.applyCallback("error",n,r)}}function p(t,e,r){e.applyCallback("loadend",t,r);var n=r.response;if(""!==r.responseType&&"text"!==r.responseType||(n=u(r)),r.status>=200&&r.status<400){var o=function(t){if(e.queue.length){var n=e.getNext();if("function"==typeof n&&!e.xhrCollection.aborted){var s=e.checkInterceptor("response",r),i=function(){var s=n(t);s?s instanceof XHRActions?s.success(function(t){o(t)}).error(function(t){o(t)}):c(s,e):e.applyCallback("success",t,r)};d&&s instanceof d?s.then(i):s&&i()}}else e.applyCallback("success",t,r)};o(n)}else r.status>=400&&r.status<600&&e.applyCallback("error",n,r)}function f(t,r){if(t){if(t.url){var u,c,h=this instanceof e?this:new XMLHttpRequest,l=r?r.addToQueue(h):new XHRPromise(h),d=!0,y=["error","timeout","progress","loadstart","load","abort","readystatechange",{type:"loadend",listener:p}];return t.method="string"==typeof t.method?t.method:f.defaults.method,void 0!==t.async&&(d=!!t.async),n(t.attributes,h),u=o(t.params),c=s(t.data),h instanceof e?h.addEventListener("event",function(t,e,r){l.applyCallback(t,e,r)}):y=y.map(function(t){var e=t instanceof Object?t.type:t,r=t instanceof Object?t.listener:t,n=a(r,l,h);return h.addEventListener(e,n),{type:e,listener:n}}),l.addEventListener("destroy",function v(){l.removeEventListener("destroy",v),y.forEach(function(t){h.removeEventListener(t.type,t.listener)})}),h.addEventListener("readystatechange",function g(){h.readyState===XMLHttpRequest.OPENED&&(h.removeEventListener("readystatechange",g),i(h,t.headers),h.send(c),l.applyCallback("request",c,h))}),setTimeout(function(){l.xhrCollection.aborted?l.applyCallback("abort",null,h):h.open(t.method,t.url+u,d)},0),l.actions}throw new Error("URL option is required.")}throw new Error("Config object is required.")}function h(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()}function l(t,r){if(t){if(t.url){var n=new e(h(),t);return f.call(n,t,r)}throw new Error("URL option is required.")}throw new Error("Config object is required.")}var d=r.Promise;return f.enableWorker=function(){return new d(function(e,r){if(f.workerMode)r(new Error("Worker can be enabled only in main thread."));else if(f._worker)e();else{var n=t.toString();n="("+n+'.call(this));\nthis.postMessage("XHR.active");\n';var o=new Blob([n],{type:"application/javascript"}),s=URL.createObjectURL(o);Object.defineProperties(f,{_worker:{value:new Worker(s)},inWorker:{value:l}}),f._worker.addEventListener("message",function i(t){"XHR.active"===t.data&&(f._worker.removeEventListener("message",i),e())})}})},Object.defineProperty(f,"defaults",{value:{method:"GET",headers:{},attributes:{responseType:"",timeout:0}},configurable:!1,writable:!1}),Object.defineProperty(f,"interceptors",{value:{response:null,responseError:null,request:null},configurable:!0,writable:!0}),f}(this),n=new Map;r.XHRActions=XHRActions,r.XHRPromise=XHRPromise,r.XHRCollection=XHRCollection,r.XHRWorker=e,r.workerMode=!~Object.getOwnPropertyNames(this).indexOf("window"),r.workerMode&&this.addEventListener("message",function(t){var e,o=t.data,s=o.guid,i=o.type;"request"===i?(o.options.url=new URL(o.options.url,location.origin),e=r(o.options).getXHR(),e.promise.guid=s,e.promise.addEventListener("destroy",function(){n["delete"](s)}),n.set(s,e)):"abort"===i&&(e=n.get(s),e&&e.abort())}),this.XHR=r}).call(this);